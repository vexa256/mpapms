<template>
  <div class="row">
    <FullScreenLoader />
    <div class="card-body pt-3 fw-bolder text-white shadow-lg table-responsive">
      <div class="alert alert-primary shadow-lg">
        <span class="float-end svg-icon svg-icon-2hx svg-icon-primary me-3">
          <i class="fas fa-info fa-2x" aria-hidden="true"></i>
        </span>
        <div class="d-flex flex-column">
          <h4 class="mb-1 text-dark">Manage Regional Admins</h4>
          <span
            >Manage and configure regional administrative roles and
            details.</span
          >
        </div>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-12 text-end">
        <button
          @click="showModal(true, {})"
          type="button"
          class="btn mx-1 float-end mb-2 btn-sm btn-danger"
        >
          <i class="fas me-1 fa-plus" aria-hidden="true"></i>New Admin
        </button>
      </div>
    </div>
    <div class="col-12">
      <div class="card-body px-5 py-5 bg-light shadow-lg table-responsive">
        <table class="table table-rounded table-bordered border gy-3 gs-3">
          <thead>
            <tr class="fw-bold text-gray-800 border-bottom border-gray-200">
              <th scope="col" class="bg-dark text-light fw-bolder">Name</th>
              <th scope="col" class="bg-dark text-light fw-bolder">Phone</th>
              <th scope="col" class="bg-dark text-light fw-bolder">Email</th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                User Code
              </th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                Nationality
              </th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                Phone Number
              </th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                Address
              </th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                Parent Organization
              </th>
              <th scope="col" class="bg-primary text-light fw-bolder">Sex</th>
              <th scope="col" class="bg-primary text-light fw-bolder">
                Job Title
              </th>
              <th scope="col" class="bg-warning text-dark fw-bolder">
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="admin in admins" :key="admin.id">
              <td class="bg-dark text-light fw-bolder">{{ admin.name }}</td>
              <td class="bg-dark text-light fw-bolder">{{ admin.Phone }}</td>
              <td class="bg-dark text-light fw-bolder">{{ admin.email }}</td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.UserCode }}
              </td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.Nationality }}
              </td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.PhoneNumber }}
              </td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.Address }}
              </td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.ParentOrganization }}
              </td>
              <td class="bg-warning text-dark fw-bolder">{{ admin.Sex }}</td>
              <td class="bg-warning text-dark fw-bolder">
                {{ admin.JobTitle }}
              </td>
              <td>
                <div class="d-flex justify-content-end">
                  <button
                    role="button"
                    class="btn btn-sm btn-warning text-dark fw-bolder me-2"
                    @click="showModal(true, admin)"
                  >
                    <i class="ki ki-pencil fs-3"></i>
                    <span class="indicator-label">Edit</span>
                  </button>
                  <button
                    role="button"
                    class="btn btn-sm btn-danger me-2"
                    @click="confirmDelete(admin)"
                  >
                    <i class="ki ki-trash fs-3"></i>
                    <span>Delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div v-if="isModalOpen" class="modal fade show d-block" id="AdminModal">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              {{ currentAdmin.id ? "Edit Admin" : "Add Admin" }}
            </h5>
            <button
              type="button"
              class="btn-close"
              @click="showModal(false, {})"
            ></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitForm" class="row">
              <div class="mb-3 col-md-4">
                <label for="Name" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.name"
                  required
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="Phone" class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.Phone"
                  required
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="Email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  v-model="currentAdmin.email"
                  required
                />
              </div>
              <!-- <div class="mb-3 col-md-4">
                <label for="UserCode" class="form-label">User Code</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.UserCode"
                />
              </div> -->
              <div class="mb-3 col-md-4">
                <label for="EntityID" class="form-label">Entity ID</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.EntityID"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="Nationality" class="form-label">Nationality</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.Nationality"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="PhoneNumber" class="form-label">Phone Number</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.PhoneNumber"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="Address" class="form-label">Address</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.Address"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="ParentOrganization" class="form-label"
                  >Parent Organization</label
                >
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.ParentOrganization"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="Sex" class="form-label">Sex</label>
                <select
                  v-model="currentAdmin.Sex"
                  class="form-control"
                  name="Sex"
                >
                  <!-- <option value=""></option> -->
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
              <div class="mb-3 col-md-4">
                <label for="JobTitle" class="form-label">Job Title</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.JobTitle"
                />
              </div>
              <div class="mb-3 col-md-4">
                <label for="AccountRole" class="form-label">Account Role</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.AccountRole"
                  value="RegionalAdmin"
                />
              </div>
              <!-- <div class="mb-3 col-md-4">
                <label for="UserID" class="form-label">User ID</label>
                <input
                  type="text"
                  class="form-control"
                  v-model="currentAdmin.UserID"
                />
              </div> -->
              <button type="submit" class="btn btn-primary">
                {{ currentAdmin.id ? "Update" : "Add" }} Admin
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: "RegionalAdminManagement",
  data() {
    return {
      admins: [],
      currentAdmin: {
        name: "",
        Phone: "",
        email: "",
        UserCode: "",
        EntityID: "",
        Nationality: "",
        PhoneNumber: "",
        Address: "",
        ParentOrganization: "",
        Sex: "",
        JobTitle: "",
        AccountRole: "RegionalAdmin",
        UserID: "",
      },
      isModalOpen: false,
    };
  },
  methods: {
    LoadDataTables() {
      setTimeout(function () {
        $("table").DataTable({
          responsive: true,
          dom: "Bfrtip",
          buttons: ["copy", "csv", "excel", "pdf", "print"],
        });
      }, 1000);
    },
    fetchAdmins() {
      this.$axios
        .post(`${window.SERVER_URL}MassFetch`, {
          TableName: "users",
          ExcludeColumns: [],
        })
        .then((response) => {
          this.admins = response.data.data;
        })
        .catch((error) => {
          console.error("Error fetching admins:", error);
        });
    },
    showModal(open, admin) {
      this.isModalOpen = open;
      this.currentAdmin = { ...admin };
    },
    submitForm() {
      const url = this.currentAdmin.id
        ? `${window.SERVER_URL}MassUpdate`
        : `${window.SERVER_URL}MassInsert`;
      const payload = { ...this.currentAdmin, TableName: "users" };
      this.$axios
        .post(url, payload)
        .then(() => {
          Swal.fire(
            "Success",
            "Admin has been processed successfully",
            "success"
          );
          this.fetchAdmins();
        })
        .catch((error) => {
          console.error("Error processing admin:", error);
        })
        .finally(() => {
          this.showModal(false, {});
        });
    },
    confirmDelete(admin) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
      }).then((result) => {
        if (result.isConfirmed) {
          this.deleteAdmin(admin.id);
        }
      });
    },
    deleteAdmin(id) {
      this.$axios
        .delete(`${window.SERVER_URL}MassDelete/RegionalAdmins/${id}`)
        .then(() => {
          Swal.fire("Deleted!", "Your admin has been deleted.", "success");
          this.fetchAdmins();
        })
        .catch((error) => {
          console.error("Error deleting admin:", error);
        });
    },
  },
  created() {
    this.fetchAdmins();
    this.LoadDataTables();
  },
};
</script>
